<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab 1 ‚Äì x86 Shellcode Reconstruction</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <div class="container">
    <h1 id="-red-team-lab-report-reconstructing-x86-linux-shellcode-execve-bin-sh-">üß™ Red Team Lab Report: Reconstructing x86 Linux Shellcode (<code>execve(&quot;/bin/sh&quot;)</code>)</h1>
<p><strong>Author:</strong> Alexander Nichols<br><strong>Date:</strong> July 5th, 2025<br><strong>Platform:</strong> Kali Linux<br><strong>Category:</strong> Red Team Development / Reverse Engineering / Assembly<br><strong>Objective:</strong> Disassemble, understand, and reconstruct <code>execve(&quot;/bin/sh&quot;)</code> shellcode from raw bytes.</p>
<hr>
<h2 id="-overview">üõèÔ∏è Overview</h2>
<p>This lab documents the full hands-on journey of analyzing a shell-spawning Linux payload generated by <code>msfvenom</code>, reverse engineering it byte-by-byte, and ultimately reconstructing a clean version from scratch in NASM.</p>
<p>The payload invokes:</p>
<pre><code class="lang-c">execve(<span class="hljs-string">"/bin/sh"</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
</code></pre>
<p>a minimal and powerful syscall used in countless Red Team payloads and post-exploitation tooling.</p>
<p>Along the way, I ran into segmentation faults, operand mismatch errors, and garbage instruction interpretation ‚Äî all of which forced me to go beyond copy-paste tactics and build a cleaner, minimal shellcode version using syscall knowledge.</p>
<hr>
<h2 id="-goals">üß† Goals</h2>
<ul>
<li><p>Generate and inspect raw Linux x86 shellcode with <code>msfvenom</code></p>
</li>
<li><p>Disassemble with <code>ndisasm</code> and analyze opcode logic</p>
</li>
<li><p>Rebuild clean shellcode from scratch in NASM</p>
</li>
<li><p>Debug segmentation faults and operand errors</p>
</li>
<li><p>Compare real-world shellcode vs clean lab variant</p>
</li>
</ul>
<hr>
<h2 id="-lab-environment">üõ†Ô∏è Lab Environment</h2>
<table>
<thead>
<tr>
<th>Component</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>Kali Linux 2024.2 (64-bit)</td>
</tr>
<tr>
<td>Architecture</td>
<td>32-bit (x86, via <code>ld -m elf_i386</code>)</td>
</tr>
<tr>
<td>Tools Used</td>
<td><code>msfvenom</code>, <code>nasm</code>, <code>ndisasm</code>, <code>ld</code>, <code>gdb</code>, <code>xxd</code>, <code>nano</code></td>
</tr>
<tr>
<td>Directory</td>
<td><code>~/red_team_labs/1_x86_shellcode_reconstructing_malware</code></td>
</tr>
<tr>
<td>Payload</td>
<td><code>linux/x86/exec CMD=&quot;/bin/sh&quot;</code></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-step-1-generate-shellcode-with-msfvenom-">üì¶ Step 1: Generate Shellcode with <code>msfvenom</code></h2>
<pre><code class="lang-bash">mkdir -<span class="hljs-selector-tag">p</span> ~/red_team_labs/<span class="hljs-number">1</span>_x86_shellcode_reconstructing_malware
cd ~/red_team_labs/<span class="hljs-number">1</span>_x86_shellcode_reconstructing_malware

msfvenom -<span class="hljs-selector-tag">p</span> linux/x86/exec CMD=<span class="hljs-string">"/bin/sh"</span> -f raw -o shellcode.raw
</code></pre>
<p>Output:</p>
<pre><code>[-] No platform was selected, choosing Msf::Module::Platform::Linux <span class="hljs-keyword">from</span> the payload
[-] No arch selected, selecting arch: x86 <span class="hljs-keyword">from</span> the payload
Payload size: <span class="hljs-number">43</span> bytes
Saved <span class="hljs-keyword">as</span>: shellcode.raw
</code></pre><p>Inspect raw bytes:</p>
<pre><code class="lang-bash"><span class="hljs-selector-tag">xxd</span> <span class="hljs-selector-tag">shellcode</span><span class="hljs-selector-class">.raw</span>
</code></pre>
<p>Output:</p>
<pre><code>00000000: 6a0b<span class="hljs-number"> 5899 </span>5266 682d<span class="hljs-number"> 6389 </span>e768 2f73<span class="hljs-number"> 6800 </span> j.X.Rfh-c..h/sh.
00000010: 682f<span class="hljs-number"> 6269 </span>6e89 e352 e808<span class="hljs-number"> 0000 </span>002f<span class="hljs-number"> 6269 </span> h/bin..R...../bi
00000020: 6e2f<span class="hljs-number"> 7368 </span>0057<span class="hljs-number"> 5389 </span>e1cd<span class="hljs-number"> 80 </span>             n/sh.WS....
</code></pre><hr>
<h2 id="-step-2-disassemble-with-ndisasm-">üîç Step 2: Disassemble with <code>ndisasm</code></h2>
<pre><code class="lang-bash">ndisasm -<span class="hljs-selector-tag">b</span> <span class="hljs-number">32</span> shellcode.raw
</code></pre>
<pre><code><span class="hljs-symbol">00000000 </span> <span class="hljs-number">6</span>A0B              push byte +<span class="hljs-number">0</span>xb
<span class="hljs-symbol">00000002 </span> <span class="hljs-number">58</span>                pop eax
<span class="hljs-symbol">00000003 </span> <span class="hljs-number">99</span>                cdq
<span class="hljs-symbol">00000004 </span> <span class="hljs-number">52</span>                push edx
<span class="hljs-symbol">00000005 </span> <span class="hljs-number">66682D63</span>          push word <span class="hljs-number">0</span>x632d
<span class="hljs-symbol">00000009 </span> <span class="hljs-number">89E7</span>              mov edi,esp
<span class="hljs-number">0000000</span>B  <span class="hljs-number">682</span>F736800        push dword <span class="hljs-number">0</span>x68732f
<span class="hljs-symbol">00000010 </span> <span class="hljs-number">682</span>F62696E        push dword <span class="hljs-number">0</span>x6e69622f
<span class="hljs-symbol">00000015 </span> <span class="hljs-number">89E3</span>              mov ebx,esp
<span class="hljs-symbol">00000017 </span> <span class="hljs-number">52</span>                push edx
<span class="hljs-symbol">00000018 </span> E808000000        <span class="hljs-keyword">call</span> <span class="hljs-number">0</span>x25
<span class="hljs-number">0000001D</span>  <span class="hljs-number">2</span>F                das
<span class="hljs-number">0000001E</span>  <span class="hljs-number">62696E</span>            bound ebp,[ecx+<span class="hljs-number">0</span>x6e]
<span class="hljs-symbol">00000021 </span> <span class="hljs-number">2</span>F                das
<span class="hljs-symbol">00000022 </span> <span class="hljs-number">7368</span>              jnc <span class="hljs-number">0</span>x8c
<span class="hljs-symbol">00000024 </span> <span class="hljs-number">005753</span>            add [edi+<span class="hljs-number">0</span>x53],dl
<span class="hljs-symbol">00000027 </span> <span class="hljs-number">89E1</span>              mov ecx,esp
<span class="hljs-symbol">00000029 </span> CD80              <span class="hljs-keyword">int</span> <span class="hljs-number">0</span>x80
</code></pre><hr>
<h2 id="-reverse-engineering-attempts-troubleshooting-deep-dive">ü§ß Reverse Engineering Attempts &amp; Troubleshooting Deep Dive</h2>
<h3 id="-initial-assembly-attempt">üö´ Initial Assembly Attempt</h3>
<p>Using the disassembled output above, I created a file called <code>shell.asm</code> and attempted to reconstruct the shellcode:</p>
<pre><code class="lang-nasm"><span class="hljs-meta">BITS</span> <span class="hljs-number">32</span>
<span class="hljs-meta">global</span> _start

<span class="hljs-meta">section</span> .text
<span class="hljs-symbol">_start:</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">byte</span> +<span class="hljs-number">0xb</span>
    <span class="hljs-keyword">pop</span> <span class="hljs-built_in">eax</span>
    <span class="hljs-keyword">cdq</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">edx</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">word</span> <span class="hljs-number">0x632d</span>
    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">edi</span>, <span class="hljs-built_in">esp</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">dword</span> <span class="hljs-number">0x68732f</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">dword</span> <span class="hljs-number">0x6e69622f</span>
    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>, <span class="hljs-built_in">esp</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">edx</span>
    <span class="hljs-keyword">call</span> short get_string
<span class="hljs-symbol">
get_string:</span>
    <span class="hljs-keyword">pop</span> <span class="hljs-built_in">ecx</span>
    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">esp</span>
    <span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span>
</code></pre>
<h3 id="-errors-encountered">‚ùå Errors Encountered</h3>
<ol>
<li><p><code>nasm</code> refused to compile due to operand mismatch:</p>
<pre><code> <span class="hljs-keyword">error</span>: mismatch <span class="hljs-keyword">in</span> operand sizes
</code></pre></li>
<li><p>Changing to full <code>dword</code> push fixed that, but execution segfaulted:</p>
<pre><code class="lang-bash"> ./<span class="hljs-built_in">shell</span>
 zsh: segmentation fault  ./<span class="hljs-built_in">shell</span>
</code></pre>
</li>
<li><p>Inline data from <code>call</code>+<code>pop</code> trick caused garbage interpretation (<code>das</code>, <code>bound</code>, etc.)</p>
</li>
</ol>
<hr>
<h2 id="-the-pivot">‚ôªÔ∏è The Pivot</h2>
<p>Instead of replicating msfvenom&#39;s obfuscation and <code>call</code>-based relative addressing, I rewrote the shellcode cleanly based on how <code>execve()</code> works:</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">execve</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *pathname, <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> argv[], <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> envp[])</span></span>;
</code></pre>
<table>
<thead>
<tr>
<th>Register</th>
<th>Purpose</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ebx</code></td>
<td>filename ptr</td>
<td><code>/bin//sh</code></td>
</tr>
<tr>
<td><code>ecx</code></td>
<td>argv ptr</td>
<td>NULL</td>
</tr>
<tr>
<td><code>edx</code></td>
<td>envp ptr</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-final-working-shell-asm">‚úÖ Final Working shell.asm</h2>
<pre><code class="lang-nasm"><span class="hljs-comment">; shell.asm - execve("/bin//sh", NULL, NULL)</span>

<span class="hljs-meta">BITS</span> <span class="hljs-number">32</span>
<span class="hljs-meta">global</span> _start

<span class="hljs-meta">section</span> .text
<span class="hljs-symbol">_start:</span>
    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>, <span class="hljs-number">0xb</span>            <span class="hljs-comment">; syscall: execve</span>
    <span class="hljs-keyword">cdq</span>                     <span class="hljs-comment">; edx = 0 (envp = NULL)</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">edx</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">dword</span> <span class="hljs-number">0x68732f2f</span>   <span class="hljs-comment">; //sh</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">dword</span> <span class="hljs-number">0x6e69622f</span>   <span class="hljs-comment">; /bin</span>
    <span class="hljs-keyword">mov</span> <span class="hljs-built_in">ebx</span>, <span class="hljs-built_in">esp</span>            <span class="hljs-comment">; ebx -&gt; "/bin//sh"</span>
    <span class="hljs-keyword">push</span> <span class="hljs-built_in">edx</span>                <span class="hljs-comment">; argv = NULL</span>
    <span class="hljs-keyword">xor</span> <span class="hljs-built_in">ecx</span>, <span class="hljs-built_in">ecx</span>            <span class="hljs-comment">; ecx = NULL</span>
    <span class="hljs-keyword">int</span> <span class="hljs-number">0x80</span>                <span class="hljs-comment">; syscall</span>
</code></pre>
<hr>
<h2 id="-build-and-run">üîß Build and Run</h2>
<pre><code class="lang-bash">nasm -f elf32 shell<span class="hljs-selector-class">.asm</span> -o shell<span class="hljs-selector-class">.o</span>
ld -m elf_i386 shell<span class="hljs-selector-class">.o</span> -o shell
./shell
</code></pre>
<p>‚úÖ <strong>Result:</strong> Dropped into a working <code>/bin/sh</code> shell!</p>
<hr>
<h2 id="-real-world-vs-clean-shellcode">üîÑ Real-World vs Clean Shellcode</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>msfvenom Shellcode</th>
<th>Clean Shellcode</th>
</tr>
</thead>
<tbody>
<tr>
<td>Obfuscation</td>
<td>Yes (call + inline)</td>
<td>None</td>
</tr>
<tr>
<td>Operand tricks</td>
<td>push byte/word</td>
<td>push dword only</td>
</tr>
<tr>
<td>Segfault-prone</td>
<td>Yes (junk data)</td>
<td>No</td>
</tr>
<tr>
<td>Assembly-friendly</td>
<td>‚ùå Not reusable</td>
<td>‚úÖ Easily reusable</td>
</tr>
<tr>
<td>Educational clarity</td>
<td>‚ùå Hard to trace</td>
<td>‚úÖ Straightforward logic</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-red-teaming-value">üîê Red Teaming Value</h2>
<p>This lab reinforced:</p>
<ul>
<li><p>Linux syscall register mapping</p>
</li>
<li><p>x86 assembly syntax and calling conventions</p>
</li>
<li><p>Disassembly and reverse engineering</p>
</li>
<li><p>Avoiding and debugging segmentation faults</p>
</li>
<li><p>Why msfvenom uses position-independent code</p>
</li>
<li><p>How to strip obfuscation for clarity and reuse</p>
</li>
</ul>
<hr>
<h2 id="-optional-extensions">üîÆ Optional Extensions</h2>
<ul>
<li><p>XOR encode + decoder stub in NASM</p>
</li>
<li><p>Wrapper C program with inline shellcode</p>
</li>
<li><p>Write a connect-back reverse shell manually</p>
</li>
<li><p>Avoid <code>int 0x80</code> with <code>sysenter</code> or dynamic syscall lookup</p>
</li>
</ul>
<hr>
<h2 id="-skills-demonstrated">‚úÖ Skills Demonstrated</h2>
<p>‚úÖ Linux syscall internals<br>‚úÖ Shellcode reconstruction<br>‚úÖ Disassembly and debugging<br>‚úÖ Assembly authoring and linking<br>‚úÖ Reverse engineering mindset</p>
<hr>
<h2 id="-next-labs">üöÄ Next Labs</h2>
<ul>
<li><p>x86 reverse TCP connect-back shell</p>
</li>
<li><p>XOR polymorphic decoder</p>
</li>
<li><p>Shellcode injection via stack overflow</p>
</li>
<li><p>Runtime shellcode loader in C</p>
</li>
</ul>
<hr>
<p><em>All work performed in a self-contained Kali Linux lab. Questions or other inquiries? <a href="url">Here's my LinkedIn!</a></em></p>

    <!-- Add a link back to Labs -->
    <hr />
    <p><a href="labs.html">‚¨Ö Back to Labs</a></p>
  </div>

  <!-- Dark mode toggle -->
  <button id="mode-toggle">üåô</button>
  <script src="assets/js/darkmode.js"></script>
</body>
</html>

